package main

// —ç—Ç–æ—Ç —Ñ–∞–π–ª –Ω—É–∂–µ–Ω –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–¥, –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞, —Å–±–æ—Ä–∫–∏ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

import (
	"log" // –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
	//"net/http"

	"fmt"
	"os"

	"github.com/jmoiron/sqlx"

	_ "github.com/lib/pq"

	"github.com/MIrrox27/REST-API/internal/adapter/http"
)

func initDB() *sqlx.DB {
	// 1. –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (DSN).
	// DSN (Data Source Name) - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å –ª–æ–≥–∏–Ω–æ–º, –ø–∞—Ä–æ–ª–µ–º, —Ö–æ—Å—Ç–æ–º –∏ –∏–º–µ–Ω–µ–º –ë–î.
	// –í –∏–¥–µ–∞–ª–µ, –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—Ä–∞—Ç—å—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!).
	dsn := os.Getenv("DATABASE_URL")
	if dsn == "" {
		// –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
		log.Println("\n\n--–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DSN –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DATABASE_URL –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.")
		dsn = "user=postgres password=1234 host=localhost dbname=REST-API sslmode=disable"
	}

	// 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:
	// sqlx.Connect:
	//   - –ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä ("postgres"): –ì–æ–≤–æ—Ä–∏—Ç, –∫–∞–∫–æ–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.
	//   - –í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä (dsn): –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
	db, err := sqlx.Connect("postgres", dsn)
	if err != nil {
		// –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
		log.Fatalf("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL: %v", err)
	}

	// 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
	db.SetMaxOpenConns(25)

	fmt.Println("--üéâ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!")
	return db
}

func main() {

	db := initDB()

	// 'defer' –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–æ, –∫–æ–≥–¥–∞ main() –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–∞–±–æ—Ç—É.
	defer db.Close()

	fmt.Println()
	http.NewServer()
}
